/*
Deployment script for DBTier3

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "DBTier3"
:setvar DefaultFilePrefix "DBTier3"
:setvar DefaultDataPath "C:\Users\Tibor Fekete\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB"
:setvar DefaultLogPath "C:\Users\Tibor Fekete\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
The type for column city in table [dbo].[AddressTable] is currently  NCHAR (10) NULL but is being changed to  VARCHAR (50) NULL. Data loss could occur.

The type for column doorSide in table [dbo].[AddressTable] is currently  NCHAR (10) NULL but is being changed to  VARCHAR (50) NULL. Data loss could occur.

The type for column postCode in table [dbo].[AddressTable] is currently  NCHAR (10) NULL but is being changed to  CHAR (4) NULL. Data loss could occur.

The type for column street in table [dbo].[AddressTable] is currently  NCHAR (10) NULL but is being changed to  VARCHAR (50) NULL. Data loss could occur.

The type for column streetNr in table [dbo].[AddressTable] is currently  NCHAR (10) NULL but is being changed to  VARCHAR (50) NULL. Data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[AddressTable])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
/*
The column [dbo].[EventTable].[descriptions] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[EventTable])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'Rename refactoring operation with key ebd0230f-33be-4d0d-8ca5-f0b23b5158c0 is skipped, element [dbo].[AddressTable].[Address] (SqlSimpleColumn) will not be renamed to AddressId';


GO
PRINT N'Rename refactoring operation with key a3853f14-c594-424f-baf7-c3e74aa6d246 is skipped, element [dbo].[EventTable].[Address] (SqlSimpleColumn) will not be renamed to AddressId';


GO
PRINT N'Rename refactoring operation with key c2d42a53-4bdf-4e2b-b170-b14c12bc1288 is skipped, element [dbo].[EventTable].[Date] (SqlSimpleColumn) will not be renamed to DateId';


GO
PRINT N'Rename refactoring operation with key 33361b3d-31f3-4b08-9a0b-c25374e44f98 is skipped, element [dbo].[EventTable].[food] (SqlSimpleColumn) will not be renamed to foodId';


GO
PRINT N'Rename refactoring operation with key e49194e3-0c38-4de2-a4a7-567c9e40a1bd is skipped, element [dbo].[EventTable].[drink] (SqlSimpleColumn) will not be renamed to drinkId';


GO
PRINT N'Rename refactoring operation with key 28aeb674-2922-4ae2-81e7-8c4e62b579ea is skipped, element [dbo].[DrinkTable].[drink] (SqlSimpleColumn) will not be renamed to drinkId';


GO
PRINT N'The following operation was generated from a refactoring log file 42891074-4f54-4641-9dd9-daee3d2ced40';

PRINT N'Rename [dbo].[FoodTable].[food] to foodId';


GO
EXECUTE sp_rename @objname = N'[dbo].[FoodTable].[food]', @newname = N'foodId', @objtype = N'COLUMN';


GO
PRINT N'Rename refactoring operation with key fe69fd87-0c90-4699-8aa9-b2a6a7374803 is skipped, element [dbo].[UserTable].[address] (SqlSimpleColumn) will not be renamed to addressId';


GO
PRINT N'Dropping [dbo].[FK_EventTable_AddressTable]...';


GO
ALTER TABLE [dbo].[EventTable] DROP CONSTRAINT [FK_EventTable_AddressTable];


GO
PRINT N'Dropping [dbo].[FK_EventTable_UserTable]...';


GO
ALTER TABLE [dbo].[EventTable] DROP CONSTRAINT [FK_EventTable_UserTable];


GO
PRINT N'Dropping [dbo].[FK_EventTable_Date]...';


GO
ALTER TABLE [dbo].[EventTable] DROP CONSTRAINT [FK_EventTable_Date];


GO
PRINT N'Dropping [dbo].[FK_EventTable_DrinkTable]...';


GO
ALTER TABLE [dbo].[EventTable] DROP CONSTRAINT [FK_EventTable_DrinkTable];


GO
PRINT N'Dropping [dbo].[FK_EventTable_FoodTable]...';


GO
ALTER TABLE [dbo].[EventTable] DROP CONSTRAINT [FK_EventTable_FoodTable];


GO
PRINT N'Altering [dbo].[AddressTable]...';


GO
ALTER TABLE [dbo].[AddressTable] ALTER COLUMN [city] VARCHAR (50) NULL;

ALTER TABLE [dbo].[AddressTable] ALTER COLUMN [doorSide] VARCHAR (50) NULL;

ALTER TABLE [dbo].[AddressTable] ALTER COLUMN [postCode] CHAR (4) NULL;

ALTER TABLE [dbo].[AddressTable] ALTER COLUMN [street] VARCHAR (50) NULL;

ALTER TABLE [dbo].[AddressTable] ALTER COLUMN [streetNr] VARCHAR (50) NULL;


GO
PRINT N'Starting rebuilding table [dbo].[EventTable]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_EventTable] (
    [eventId]       CHAR (10)    NOT NULL,
    [userId]        CHAR (4)     NOT NULL,
    [AddressId]     CHAR (4)     NOT NULL,
    [DateId]        CHAR (4)     NOT NULL,
    [foodId]        CHAR (4)     NOT NULL,
    [drinkId]       CHAR (4)     NOT NULL,
    [startTime]     VARCHAR (50) NOT NULL,
    [endTime]       VARCHAR (50) NOT NULL,
    [description]   VARCHAR (50) NULL,
    [ageLimit]      VARCHAR (50) NULL,
    [pets]          VARCHAR (50) NULL,
    [entertainment] VARCHAR (50) NULL,
    [guests]        INT          NOT NULL,
    [welcomeFee]    INT          NULL,
    PRIMARY KEY CLUSTERED ([eventId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[EventTable])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_EventTable] ([eventId], [userId], [AddressId], [DateId], [foodId], [drinkId], [startTime], [endTime], [ageLimit], [pets], [entertainment], [guests], [welcomeFee])
        SELECT   [eventId],
                 [userId],
                 [AddressId],
                 [DateId],
                 [foodId],
                 [drinkId],
                 [startTime],
                 [endTime],
                 [ageLimit],
                 [pets],
                 [entertainment],
                 [guests],
                 [welcomeFee]
        FROM     [dbo].[EventTable]
        ORDER BY [eventId] ASC;
    END

DROP TABLE [dbo].[EventTable];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_EventTable]', N'EventTable';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[FK_EventTable_AddressTable]...';


GO
ALTER TABLE [dbo].[EventTable] WITH NOCHECK
    ADD CONSTRAINT [FK_EventTable_AddressTable] FOREIGN KEY ([AddressId]) REFERENCES [dbo].[AddressTable] ([AddressId]);


GO
PRINT N'Creating [dbo].[FK_EventTable_UserTable]...';


GO
ALTER TABLE [dbo].[EventTable] WITH NOCHECK
    ADD CONSTRAINT [FK_EventTable_UserTable] FOREIGN KEY ([userId]) REFERENCES [dbo].[UserTable] ([userId]);


GO
PRINT N'Creating [dbo].[FK_EventTable_Date]...';


GO
ALTER TABLE [dbo].[EventTable] WITH NOCHECK
    ADD CONSTRAINT [FK_EventTable_Date] FOREIGN KEY ([DateId]) REFERENCES [dbo].[Date] ([DateId]);


GO
PRINT N'Creating [dbo].[FK_EventTable_DrinkTable]...';


GO
ALTER TABLE [dbo].[EventTable] WITH NOCHECK
    ADD CONSTRAINT [FK_EventTable_DrinkTable] FOREIGN KEY ([drinkId]) REFERENCES [dbo].[DrinkTable] ([drinkId]);


GO
PRINT N'Creating [dbo].[FK_EventTable_FoodTable]...';


GO
ALTER TABLE [dbo].[EventTable] WITH NOCHECK
    ADD CONSTRAINT [FK_EventTable_FoodTable] FOREIGN KEY ([foodId]) REFERENCES [dbo].[FoodTable] ([foodId]);


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'ebd0230f-33be-4d0d-8ca5-f0b23b5158c0')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('ebd0230f-33be-4d0d-8ca5-f0b23b5158c0')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'a3853f14-c594-424f-baf7-c3e74aa6d246')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('a3853f14-c594-424f-baf7-c3e74aa6d246')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'c2d42a53-4bdf-4e2b-b170-b14c12bc1288')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('c2d42a53-4bdf-4e2b-b170-b14c12bc1288')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '33361b3d-31f3-4b08-9a0b-c25374e44f98')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('33361b3d-31f3-4b08-9a0b-c25374e44f98')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'e49194e3-0c38-4de2-a4a7-567c9e40a1bd')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('e49194e3-0c38-4de2-a4a7-567c9e40a1bd')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '28aeb674-2922-4ae2-81e7-8c4e62b579ea')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('28aeb674-2922-4ae2-81e7-8c4e62b579ea')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '42891074-4f54-4641-9dd9-daee3d2ced40')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('42891074-4f54-4641-9dd9-daee3d2ced40')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'fe69fd87-0c90-4699-8aa9-b2a6a7374803')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('fe69fd87-0c90-4699-8aa9-b2a6a7374803')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[EventTable] WITH CHECK CHECK CONSTRAINT [FK_EventTable_AddressTable];

ALTER TABLE [dbo].[EventTable] WITH CHECK CHECK CONSTRAINT [FK_EventTable_UserTable];

ALTER TABLE [dbo].[EventTable] WITH CHECK CHECK CONSTRAINT [FK_EventTable_Date];

ALTER TABLE [dbo].[EventTable] WITH CHECK CHECK CONSTRAINT [FK_EventTable_DrinkTable];

ALTER TABLE [dbo].[EventTable] WITH CHECK CHECK CONSTRAINT [FK_EventTable_FoodTable];


GO
PRINT N'Update complete.';


GO
